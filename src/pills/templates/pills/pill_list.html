{% extends "base.html" %}

{% block content %}

<h1 style="text-align: center;">Pill list</h1>


	<div class='container'>
  		<div class="row">
  		{% for pills in object_list %}
  			<div class="col-lg-4">
			  	<div class="card mb-3" style="width: 18rem;">
			  		<a href="{{ pills.get_absolute_url }}"><h3 class="card-header" style="text-align: center;">{{ pills.name }}</h3></a>
			  		<div class="card-body">

			  		
						<input type="button" class="like btn-danger" name="{{ pills.id }}" value="Like">
					    <p id="count-{{ pills.id }}">좋아요 {{ pills.like_count }}개</p>
					    <p id="like-user-{{ pills.id }}">
					    	좋아하는 사람 :
					    	{% for like_user in pills.like_user_set.all %}
						    	{{ like_user.username }},
						    {% endfor %}
					    </p>
					

			  			<h5 class="card-title" style="height: 45px;"">특징: {{ pills.feature }}</h5>
			  			<h6 class="card-subtitle text-muted" style="height: 25px;">특별 코멘트: {{ pills.editor_said }}</h6>
			  		</div>
			  		<img style="height: 200px; width: 100%; display: block;" src="{{ pills.image.url }}" alt="Card image">
			  		<div class="card-body">
			  			<p class="card-text" style="height: 200px;">{{ pills.description|truncatechars:200 }}</p>
			  		</div>
			  		<ul class="list-group list-group-flush">
			  			<li class="list-group-item"><b>효능:</b> <small>{{ pills.benefit|truncatechars:20 }}</small></li>
			  			<li class="list-group-item"><b>결핍 시:</b> <small>{{ pills.shortage|truncatechars:20 }}</small></li>
			  			<li class="list-group-item"><b>주의 할 점:</b> <small>{{ pills.careful|truncatechars:20 }}</small></li>
			  		</ul>
			  		<div class="card-body">
			 			<a href="#" class="card-link">Card link</a>
			  			<a href="#" class="card-link">관련기사 링크</a>
			  		</div>
			  		<div class="card-footer text-muted">
			  			여긴 베댓 넣을꺼임
			  		</div>
		  		</div>
		  	</div>
		{% empty %}
		
			{% if request.GET.q %}
				{% include 'pills/search_form.html' %}
				<div class="container-fluid">
					<p></p>
					<p style="text-align: center;">그런 영양제 없음</p>
					
				</div>
			{% endif %}
			
		{% endfor %}

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript">
  $(".like").click(function(){
	var pk = $(this).attr('name')
	$.ajax({
		type: "POST",
		url: "{% url 'pills:pill_like' %}",
		data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // 서버로 데이터 전송할 때, 옵션.
		dataType: "json",

      // 서버측에서 전송한 Response 데이터 형식 (json)

      success: function(response){ // 성공시 - 좋아요, 유저 목록 변경
      	alert(response.message);
      	$("#count-"+pk).html(response.like_count+"개");

      	var users = $("#like-user-"+pk).text();

      	if(users.indexOf(response.username) != -1){
      		$("#like-user-"+pk).text(users.replace(response.username, ""));
      	}else{
      		$("#like-user-"+pk).text(response.username+users);
      	}
      },
      error: function(request, status, error){ // 실패시 - 로그인 페이지 리다이렉트
      	alert("로그인이 필요합니다.")
      	window.location.replace("/accounts/login/")
        //  alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
      },
	});
  })
</script>


{% endblock %}